input {
  tcp {
    port => 5000
    codec => json_lines
    type => "wazuh_alerts"
  }
  beats {
    port => 5044
    type => "filebeat"
  }
}


filter {
  if [type] == "wazuh_alerts" {
    # Process Wazuh alerts (already JSON)
    json {
      source => "message"
      target => "wazuh"
    }
    mutate {
      remove_field => ["message", "tags"] # Remove original message field if already parsed
    }
  } else if [type] == "filebeat" {
    # Process logs from Filebeat (Coraza, AI service, etc.)
    if [log][file][path] =~ "/var/log/coraza/audit.log" {
      grok {
        match => { "message" => "(?m)%{NOTSPACE:coraza_transaction_id}\s%{IPORHOST:client_ip}\s%{INT:client_port}\s%{NOTSPACE:target_ip}\s%{INT:target_port}\s%{WORD:method}\s%{URIPATH:request_path}\s%{NUMBER:status_code}\s%{INT:request_size}\s%{INT:response_size}\s%{NUMBER:request_duration}\s%{NOTSPACE:rule_id}\s%{WORD:action}\s%{NOTSPACE:phase}\s%{GREEDYDATA:message_details}" }
        # You'll need more refined grok patterns for full Coraza audit log parsing (parts B, C, E, F, H, Z)
        # This is a very basic example for "A" part of audit log.
      }
      mutate {
        add_field => { "log_type" => "coraza_audit" }
      }
    } else if [log][file][path] =~ "/var/log/coraza/debug.log" {
      grok {
        match => { "message" => "\[%{TIMESTAMP_ISO8601:timestamp}\]\s\[%{LOGLEVEL:log_level}\]\s\[%{GREEDYDATA:log_message}\]" }
      }
      mutate {
        add_field => { "log_type" => "coraza_debug" }
      }
    } else if [log][file][path] =~ "/var/log/messages" {
      # For AI microservice logs from /var/log/messages (Python app's stdout/stderr)
      # This is a generic syslog pattern, might need adjustment for specific app logging formats
      grok {
        match => { "message" => "%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}(?:\[%{POSINT:syslog_pid}\])?: %{GREEDYDATA:syslog_message}" }
      }
      mutate {
        add_field => { "log_type" => "application_log" }
      }
    }
  }
}


output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "wazuh-alerts-%{+YYYY.MM.dd}"
    # Use "wazuh-alerts" for Wazuh data, and separate index for other logs
    # or use a single index and differentiate by 'log_type' field in Kibana
    # For simplicity, sending everything to a daily index.
  }
  stdout { codec => rubydebug } # For debugging
}
